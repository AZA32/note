# 分布式一致性

### 拜占庭将军问题

在分布式计算机网络中，如果存在故障和恶意节点，如何保持正常节点的数据一致性。为了解决这一问题提出许多算法，称为拜占庭容错算法。

### 分布式一致性算法

在分布式系统中，依据系统对于故障组件的容错能分为崩溃容错协议（CFT）和拜占庭容错协议（BFT）

#### CFT

CFT共识算法只保证分布式系统中节点发生宕机错误时整个分布式系统的可靠性，而当系统中节点违反共识协议的时候（比如被黑客攻占，数据被恶意篡改等）将无法保障分布式系统的可靠性，常用于中心化的分布式系统。

**Paxos**

由lamport提出消息传递的分布式一致性算法，采用多数派原则。

**角色**

* 提议员（Proposer）：提出议案，包含Proposal ID（提案编号）和提议的值
* 议员（Acceptor）：对每个提议的值进行投票，并存储接受的值，若Proposal获得多数的Acceptor的接受，则该Proposal被批准
* 记录员（Learner）：被告知投票的结果，接受达成共识的值，存储保存，不参与投票的过程。像记录员。

**核心流程**

1. Prepare阶段：
   1. 提议员生成全局唯一且递增的Proposal ID，向所有议员发出Prepare请求，这里无需携带提案内容，只携带Proposal ID即可。
   2.  议员对提议员的请求进行Promise（承诺），包含

       **两个承诺**

       * 不再接受Proposal ID小于等于当前请求的Prepare请求。
       * 不再接受Proposal ID小于当前请求的Propose请求。

       **一个应答**

       * 不违背以前作出的承诺下，回复已经Accept过的提案中Proposal ID最大的那个提案的Value和Proposal ID，没有则返回空值。
2. Accept阶段
   1. 提议员收到多数议员的Promise应答后，从应答中选择Proposal ID最大的提案的Value，作为本次要发起的提案。如果所有应答的提案Value均为空值，则可以自己随意决定提案Value。然后携带当前Proposal ID，向所有议员发送Propose请求
   2. 议员收到提议员请求后，在不违背自己之前作出的承诺下，接受并持久化当前Proposal ID和提案Value。
3.  Learn阶段

    提议员收到多数议员的Accept后，决议形成，将形成的决议发送给所有记录员

**Zab**

基于**Paxos**改进，为Zookeeper实现一套支持崩溃恢复和原子广播的协议。Zookeeper设计只有**Leader**能够发起事务请求，然后将数据同步到其它**Follower**节点。

**角色**

* Leader
* Follower

**崩溃恢复**

**Leader选举**

**数据同步**

**原子广播**

当集群通讯正常时如何进行数据广播

#### BFT

针对系统中存在恶意节点的情况

> 通常会假设某个恶意节点数量小于某个值，以此条件作为前提条件进行共识算法设计
>
> POW假设恶意节点占比小于1/2，PBFT假设恶意节点占比小于1/3

**POW**

工作量证明，通过计算一个随机数（nonce）

**流程**

1. 新交易向所有节点广播消息
2. 节点将交易打包进区块
3. 进行随机数计算满足nonce设定
4. 满足要求的节点进行广播
5. 其它节点收到进行验证

**优点**

**缺点**

**POS**

权益证明

**优点**

**缺点**

**DPoS**

股权授权证明

**优点**

**缺点**
